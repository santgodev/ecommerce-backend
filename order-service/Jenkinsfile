pipeline {
  agent any

  tools {
    jdk 'java17016'
    maven 'maven399'
  }

  environment {
    SERVICE = 'order-service'
    IMAGE = "farmatodo/${SERVICE}:${BUILD_NUMBER}"

    SONAR_SCANNER_HOME = tool 'sonar7'
    TRIVY_CACHE_DIR = '/var/jenkins_home/.trivycache'
  }

  options {
    timestamps()
    timeout(time: 20, unit: 'MINUTES')
  }

  stages {

    // 1Ô∏è‚É£ Checkout & Build
    stage('Checkout & Build') {
      steps {
        echo "üì¶ Clonando y compilando el microservicio ${SERVICE}..."
        checkout scmGit(
          branches: [[name: '*/main']],
          extensions: [],
          userRemoteConfigs: [[
            credentialsId: 'jenkins-gcp',
            url: 'https://github.com/santgodev/farmatodo-backend.git'
          ]]
        )

        dir(env.SERVICE) {
          echo "üß± Ejecutando build con Maven..."
          sh 'mvn -q -Dstyle.color=always clean verify -DskipTests=false'
        }
      }
    }

    // 2Ô∏è‚É£ An√°lisis est√°tico con SonarQube
    stage('SonarQube Analysis') {
      steps {
        echo "üîç Analizando calidad de c√≥digo con SonarQube..."
        dir(env.SERVICE) {
          withCredentials([string(credentialsId: 'sonartoken', variable: 'SONAR_TOKEN')]) {
            withSonarQubeEnv('sonar') {
              sh """
                ${SONAR_SCANNER_HOME}/bin/sonar-scanner \
                  -Dsonar.projectKey=${SERVICE} \
                  -Dsonar.sources=. \
                  -Dsonar.java.binaries=target/classes \
                  -Dsonar.host.url=http://sonarqube-dind:9000 \
                  -Dsonar.token=$SONAR_TOKEN
              """
            }
          }
        }
      }
    }

    // 3Ô∏è‚É£ Construcci√≥n de imagen Docker
    stage('Build Docker Image') {
      steps {
        dir(env.SERVICE) {
          echo "üê≥ Construyendo imagen Docker para ${SERVICE}..."
          sh """
            docker build -t ${IMAGE} .
            echo "‚úÖ Imagen construida: ${IMAGE}"
          """
        }
      }
    }

    // 4Ô∏è‚É£ Escaneo de seguridad con Trivy
    stage('Trivy Image Scan') {
      steps {
        echo "üß© Escaneando vulnerabilidades con Trivy..."
        dir(env.SERVICE) {
          sh """
            export TRIVY_CACHE_DIR=${TRIVY_CACHE_DIR}
            echo "üì¶ Cach√© de Trivy: ${TRIVY_CACHE_DIR}"

            trivy image \
              --no-progress \
              --skip-update \
              --light \
              --timeout 10m \
              --format table \
              --severity HIGH,CRITICAL \
              -o trivy-image-report.txt \
              ${IMAGE} || true
          """
        }
      }
    }
  }

  post {
    success {
      echo "‚úÖ Pipeline completado con √©xito para ${SERVICE}."
    }
    failure {
      echo "‚ùå Fall√≥ el pipeline de ${SERVICE}."
    }
    always {
      echo "=========================================="
      echo "üìò Service: ${SERVICE}"
      echo "üìä Status: ${currentBuild.result ?: 'SUCCESS'}"
      echo "‚è± Duration: ${currentBuild.durationString}"
      echo "=========================================="

      archiveArtifacts artifacts: "${SERVICE}/target/*.jar", allowEmptyArchive: true, fingerprint: true
      archiveArtifacts artifacts: "**/trivy-*.txt", allowEmptyArchive: true
    }
  }
}
